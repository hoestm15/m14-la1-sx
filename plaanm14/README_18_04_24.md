# Protokoll

## Thema: Weiterentwicklung eines Programmes zur Messung der Temperatur
Name: Platzer Andreas <br>
Datum: 24.04.2018 <br>
Anwesend: Platzer Andreas, Muri Lorenz, Nebel Florian, Mandl Gerhard, Mörth Michael, Martinak Moritz, Nabernik Mario, Köhler Marcel <br>
Abwesend: Es waren alle anwesend. <br>
Abgabe Datum: 12.06.2018 <br>

### Wiederholung und Fortsetzung des Programmes 
Am Beginn dieser Einheit wurden die wichtigsten Merkmale der letzten Einheit besprochen, anschließend wurden noch die Protokolle angeschaut und bewertet. Alle der folgenden Quellcodes und Programmteile stammen aus dieser Einheit. 

Hinzugefügte Programmteile:
* Die Methode connect()
* Die Methode startSingleMeasurement()
* Die Methode updateSwingControlles()
* Die Klasse SingleMeasurementWorker
* Der Klassenvariable activeWorker
* Die Klasse MySingleMeasurementWorker



#### Die Methode connect()
Diese Methode ist für das Bereitstellen der vorhandenen Geräte und der Verknüpfung von dieser.
Wie im ersten Teil des Quellcodes beschrieben, werden zuerst die vorhandenen Geräte in einen String geschrieben. Anschließend wird das Port geöffnet und es werden die Einstellungen für die Übertragung festgelegt. Im Falle von Fehlen wird zuerst versucht das Port zu schließen, treten weitere Fehler auf wird eine Fehlermeldung ausgegeben.

```java
  private void connect()
  {
    try
    {
      String port = (String) jcbSerialDevice.getSelectedItem();         //Neuer String mit verfügbaren Ports 
      serialPort = new jssc.SerialPort(port);                           
      serialPort.openPort();                                            //Öffnet das Port
      serialPort.setParams                                              //Setzt die Parameter die für die Übertragung wichtig sind  
      (                                                                          
      SerialPort.BAUDRATE_57600,                                        //Festlegung der Baurate
      SerialPort.DATABITS_8,                                            //Festlegung auf 8 Datenbits pro übertragung 
      SerialPort.STOPBITS_2,                                            //Es gibt 2 Stopbits
      SerialPort.PARITY_NONE                                            //Parity Einstellungen 
      );                                
      updateSwingControlles();
    }
    catch (Throwable th)
    {
      try 
      {
        if(serialPort != null && serialPort.isOpened())                 // Wenn ein Port offen ist oder keines verfgbar ist
          serialPort.closePort();                                       // wird das Port geschlossen.
      }
      catch(Throwable th2)
      {
        th.addSuppressed(th2);
      }
      finally
      {
        updateSwingControlles();                                         // Swing Controlles werden aktualisiert
      }
      showThrowable("Schnittstelle kann nicht geöffnet werden", th);     // Eine Fehlermeldung wird ausgegeben 
      serialPort = null;                                                 // serialPort wird auf null gesetzt
    }    
  }
```


#### Die Methode startSingleMeasurement()
Um den worker richtig ausführen zu können werden die aktuellen Ports benötigt, diese werden mit Hilfe der Variable serialPort übergeben. Der activeWorker muss anschließend gestartet werden, dies geschieht mit dem execute() (ausführen) Befehl.
```java
  private void startSingleMeasurement()
  {
    activeWorker = new MySingleMeasurementWorker(serialPort);            // Ein neuer worker wird angelegt
    activeWorker.execute();                                              // Dieser wird gestartet 
    updateSwingControlles();                                             // Swing Controlls werden aktualisiert
  }
```


#### Die Methode updateSwingControlles()
Die Methode updateSwingControlles() ist wie der Name schon sagt für die Aktualisierung des Hauptfensters zuständig. Im ersten Teil werden alle Fenster verblasst. Weiters werden die Teile je nach Änderung der Eigenschaften angepasst. Wenn der Worker arbeitet wird er Cursor auf eine warte Cursor gesetzt.
```java
  public void updateSwingControlles()
  {
    jcbSerialDevice.setEnabled(false);                                    // Alle Knöpfe werden verblasst
    jbutConnect.setEnabled(false); 
    jbutDisconnect.setEnabled(false);
    jbutRefresh.setEnabled(false);
    jbutContinousMeasurement.setEnabled(false);
    jbutStopMeasurement.setEnabled(false);
    jlaTemperatur.setEnabled(false);
    jbutSingleMeasurement.setEnabled(false);
   
    
    if(activeWorker != null)                                              // Wenn im Worker nichts existiert
    {
      setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));          // Cursor wird auf den warte Cursor gesetzt
      return;
    }
    
    setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR));         // Cursor wird auf den standard Cursor gesetzt
    jlaTemperatur.setEnabled(true);                                       // JLabel Temperature wird aktiv gesetzt 
    
    if(serialPort != null && serialPort.isOpened())                       // Wenn das Port offen ist und eine Verbindung besteht
    {
      jbutDisconnect.setEnabled(true);                                    // wird der trenn Knopf aktiviert 
      jbutSingleMeasurement.setEnabled(true);                             // der einzelmessungsknopf wird ebenfalls aktiviert 
      return;
      
    } 

    if(ports != null && ports.length > 0)                                 // Wenn eine Verbinden mit einem Port möglich ist 
    {
      jcbSerialDevice.setEnabled(true);                                   // werden die Knöpfe ebenfalls aktiviert 
      jbutConnect.setEnabled(true);
      jbutRefresh.setEnabled(true);
    }
    
    else if(ports != null && ports.length == 0)                            // Keine Ports vorhanden?
      jbutRefresh.setEnabled(true);                                        // Der aktualisierungs Knopf wird aktivierts
  }
```


#### Die Klasse SingleMeasurementWorker
Die Klasse SingleMeasurementWorker ist zuständig die Temperatur zu holen. 
Hierzu wird ein integer Feld beschrieben (diese Werte kommen aus einen Skript) und den Serial Port übergeben. Nach einer Sekunde wird die Antwort anschließend in das integer Feld geschrieben. Die Werte an der stelle 3 und 4 werden ausgelesen addiert und durch 256 dividiert. Die Temperatur ist anschließend der Rückgabewert.

```java
import java.util.concurrent.TimeUnit;                                       // Einbindung von den Bibliotheken
import jssc.SerialPort;
import javax.swing.SwingWorker;
package workers;   

public class SingleMeasurementWorker extends SwingWorker<Double,String>
{
  private final jssc.SerialPort serialPort;


  public SingleMeasurementWorker (SerialPort serialPort)
  {
    this.serialPort = serialPort;                                           // setzen des Anfangszustandes
  }
  
  @Override                                                                 // Automatisch erstellt
  protected Double doInBackground () throws Exception
  {
    int [] frame = {0x02,0x04,0x00,0x30,0x00,0x01,0x31,0xf6};               // generieren von einem Integer Feld 
    serialPort.writeIntArray(frame);                                        // für das Serial Port
    TimeUnit.SECONDS.sleep(1);                                              // warte 1 secunde
    int [] response = serialPort.readIntArray();                            // Integer Feld wird von Serial Port gelesen 
    System.out.println(response.length);                                    // länge wird ausgegeben
    double temp = response[3]+response[4] / 256.0;                          // Temperatur wird berechnet
    return temp;
  } 
  
}
```


#### Der Klassenvariable activeWorker
Dieser Klassenname wird in der GUI Klasse hinzugefügt und startet anschließend den Worker. 
```java
  private SwingWorker activeWorker;
```


#### Die Klasse MySingleMeasurementWorker
Nach dem Beenden der Background Arbeit wird done () aufgerufen. Diese Methode aktualisiert die Temperatur oder gibt eine Fehlermeldung aus im Falle eines Fehlers.
```java
  private class MySingleMeasurementWorker extends SingleMeasurementWorker
  {
    public MySingleMeasurementWorker (SerialPort serialPort)
    {
      super(serialPort);
    }

    @Override                                                                 // Automatisch erzeugt 
    protected void done ()
    {
      try
      {
        double temp = get();                                                  // Temperatur wird in temp geschreiben 
        jlaTemperatur.setText(String.format("%.01f °C", temp));               // und ausgegeben
      }
      catch (Exception ex)
      {
        showThrowable("Einzelmessung gescheitert", ex);                       // Fehlermeldung bei einem Fehler
      }
      finally
      {
        activeWorker = null;                                                   // activeWorker wird zurückgestzt 
        updateSwingControlles();                                               // Fenster wird aktualisiert 
      }
    }

    @Override                                                                  // Automatisch erzeugt 
    protected void process (List<String> chunks)                          
    {

    }  
  }
```



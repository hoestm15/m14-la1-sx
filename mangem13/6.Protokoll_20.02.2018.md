# 6.Protokoll - 20.02.2018
Schriftführer: Gerhard Mandl  
Betreuer: Sx  
Klasse: 4AHME  
Gruppe: 2  
Anwesend: Nebel Florian, Mandl Gerhard, Moritz Martinak, Muri Lorenz, Platzer Andreas, Michael Mörth, Marcel Köhler, Mario Nabernik    
Abwesend: -

## Aufgabenstellung
In dieser Stunde sollen wir aus einem SureBoards einen Temperatursensor bauen. Dazu sollen wir unsere Kentnisse über den Modbus verwenden welche wir in den vorigen Einheiten erlent haben. Die Daten sollen über einen Feldbus an den Computer übertragen werden. Diese Daten werden verarbeitet und sollen in einer Java-Swing Gui visualisiert werden.  
Für diese Übung hat Professor Steiner bereits eine Gui Vorlage erstellt welche wir [hier](https://www.htl-mechatronik.at/gitweb/me14/?p=sx-la1.git;a=commit;h=25c2c67c9c9868891a75c110045a63687523d105) downloaden können.  

Grafische Ansicht:  
![Gui](https://github.com/HTLMechatronics/m14-la1-sx/blob/mangem13/mangem13/GUI-Temperaturmessung.png)

## Das Programm  

Im folgendem Abschnitt erstellen wir zwei Variablen. Das Feld _ports_ speichert unsere gefunden Ports. Mit _serialPort_ können wir abfragen ob der Port geöffnet ist.    
```java
  private String [] ports;
  private jssc.SerialPort serialPort;
```  

Mit _jlaTemperatur.setText("? °C")_ setzen wir in den Text in der Gui auf ? °C.  
Mit _refresh()_ werden bereits beim Start des Programmes alle verfügenbaren Ports angezeigt. Auf das _refresh()_ wird später im Programm genauer eingegangen.   
```java
public SureModbusGui ()
  {
    initComponents();
    setLocationRelativeTo(null);
    jlaTemperatur.setText("? °C");
    refresh();
  }
```  
Nach dem _refresh()_ schaut die Gui folgendermasßen aus:  
[GUI - Ports gefunden](https://github.com/HTLMechatronics/m14-la1-sx/blob/mangem13/mangem13/Port_Gefunden.png)
[GUI - Keine Ports gefunden](https://github.com/HTLMechatronics/m14-la1-sx/blob/mangem13/mangem13/Kein_Port_Gefunden.png)

Die Nachfolgende Methode dient zur Fehlerausgabe. Es wird nicht genauer darauf eingegangen da diese Kenntnisse vorausgesetzt werden.  
```java
private void showThrowable (String msg, Throwable th)
  {
    th.printStackTrace(System.err);
    JOptionPane.showMessageDialog(
      this,
      msg,
      "Fehler aufgetreten", 
      JOptionPane.ERROR_MESSAGE
    );
  }
  ```  
  
  In diesem Programmabschnitt ist zu erkennen welche Buttons aktiviert und deaktiviert sein sollen, wenn man mit einem Port verbunden ist oder wenn man Ports nur gefunden hat aber mit ihnen noch keine Verbindung erstellt hat.  
   ```java
  public void updateSwingControlles()
  {
    jcbSerialDevice.setEnabled(false);
    jbutConnect.setEnabled(false);
    jbutContinousMeasurement.setEnabled(false);
    jbutDisconnect.setEnabled(false);
    jbutRefresh.setEnabled(false);
    jbutSingleMeasurement.setEnabled(false);
    jbutStopMeasurement.setEnabled(false);
    
    if(serialPort != null && serialPort.isOpened()) //Es wurde eine Verbindung mit einem Port erstellt -> Trennen möglich
    {
      jbutDisconnect.setEnabled(true);
      return;
    }
      
    
    if(ports != null && ports.length > 0) //Verbinden mit einem Port möglich
    {
      jcbSerialDevice.setEnabled(true);
      jbutConnect.setEnabled(true);
      jbutRefresh.setEnabled(true);
    }
    else if(ports != null && ports.length == 0)
      jbutRefresh.setEnabled(true);
  }
  ```
  
  Die Methode _refresh_ speichert die Namen der Ports welche in der Variable _ports_ gefunden werden. Mit dem Befehl _jcbSerialDevice.setModel(model)_, werden die Namen der Ports aufgelistet. 
_updateSwingControlles_ aktualisiert wieder die Buttons.
  ```java
  private void refresh()
  {
    ports = jssc.SerialPortList.getPortNames(); //Vorhande Ports speichern
    DefaultComboBoxModel<String> model = 
            new DefaultComboBoxModel<>(ports); 
    jcbSerialDevice.setModel(model); //Vorhandene Ports implementieren
    updateSwingControlles(); //Buttons aktualisieren
  }
  ```
  
  
Hier wählen wir den Port aus welchen wir öffnen wollen. Der Befehl _openPort()_ stellt dann die Verbindung zum Port her. 
  ```java
private void connect()
  {
    try
    {
      String port = (String) jcbSerialDevice.getSelectedItem();
      serialPort = new jssc.SerialPort(port);
      serialPort.openPort();
      updateSwingControlles();
    }
    catch (Throwable th)
    {
      showThrowable("Serielle Schnittstelle kann nicht geöffnet werden", th);
    }    
  }
  ```
  ![Gui wenn Verbunden](https://github.com/HTLMechatronics/m14-la1-sx/blob/mangem13/mangem13/Port_Verbunden.png)
  
  ### Throwable
  Bei Java Schnittstellen werden JNI-Fehler geworfen. Diese Fehler werden von der Klasse "Error" abgeleitet und nicht von der Klasse "Exception". Deshalb fängt man die Klasse __Throwable__ da die Klassen "Error" und "Exception" von dieser abgeleitet werden.
Klicke sie [hier](https://docs.oracle.com/javase/7/docs/api/java/lang/Throwable.html) für mehr Information.  



Hier wird der aktuelle offene Port wieder geschlossen (Verbindung wird getrennt)
```java
  private void disconnect()
  {
    try
    {
      serialPort.closePort();
    }
    catch (Exception e)
    {
      showThrowable("Fehler beim Schließen der Schnittstelle", e);
    }
    finally // sorgt dafür das der Port trotz Fehlermeldung geschlossen wird
    {
      serialPort = null;
      updateSwingControlles();
    }
  }
```  


Zeigt welche Aktionen ausgeführt werden wenn der jeweilige Button gedrückt wird.  
```java
  private void jbutConnectActionPerformed(java.awt.event.ActionEvent evt)                                            
  {                                                
    connect();
  }                                           

  private void jbutDisconnectActionPerformed(java.awt.event.ActionEvent evt)                                               
  {                                                   
    disconnect();
  }                                              

  private void jbutRefreshActionPerformed(java.awt.event.ActionEvent evt)                                            
  {                                                
    refresh();
  }                                           
```

  

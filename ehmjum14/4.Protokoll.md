# *Protokoll:* Julian Ehmann  

## **4. Einheit: Makefiles**  
 Name: Julian Ehmann  
 Klasse: 4AHME  
 Datum: 16.01.2018  
 Anwesend: Berger Emil, Bullner Jeremy, Böcksteiner Jakob, Ehmann Julian, Enzi Gert, Kobor Markus, Knappitsch Robert
 Abwesend: -
 
 ### Theorie zu *Makefiles*
 
 Normalerweise wird bei der Programmierung, beispielsweise in der Sprache C, zur **Übersetzung** auf eine **IDE** 
 (Integrated Development Environment) zurückgegriffen. Beispielsweise **Netbeans** arbeitet mit einer vorher genannten **IDE**. 
 Dies ist für uns bei dieser Thematik soweit interessant, da die **IDE's** mit **make** arbeiten.
 
 Wird nun das Kommando **make** in der Konsole ausgeführt, so entsteht eine **Makefile** Datei.  
 Wurde alles richtig konfiguriert in der Makefile, werden bereits abgearbeitete Befehle beim nächsten durchlauf weggelassen.
 In dieser sogenannten *Steuerdatei* sind die wichtigsten Daten(Informationen) erhalten:
 
* welche Abhängigkeiten wurden definiert?
* was für Tools (Linker, etc.) werden wann aufgerufen?  
* Ziel der Übersetzung?
* zugehörigen Dateien des Projektes?


### Schrittweise Übersetzung einer C-Datei


*Step 1. Datei Compilieren*  

Für den Atmega328p benötigen wir die Kommandozeile *avr-gcc*.  
Nach der Compilierung mit dem *GNU-Compiler*  
steht eine Datei mit der Endung **.o** zur verfügung.  

Der hierfür benötigte Befehl lauetet: 
 ```
 avr-gcc -mmcu=atmega328p -Os -c main.c
 ```  
  **-mmcu**  legt den Microcontroller-Typ fest.  
  **-c**     ist ein extra Parameter, der angibt, dass nur compiliert werden soll.  
 
 *Step 2. Datei Linken*  
 
 Der nächste Arbeitsgang ist das *Linken*.   
 Nach diesem Vorgang entsteht eine Datei mit der Endung **.elf**.  
 
 Der hierfür benötigte Befehl lauetet:  
```
 avr-gcc -mmcu=atmega328p -Os -o main.elf main.o
 ```  
 *Step 3. Generieren einer Hex-Datei*  
 
 In diesem Abschnitt wird aus der **.elf** Datei eine  
 Datei mit der Endung **.hex** generiert.  
 
 Der hierfür benötigte Befehl lauetet:  
 ```
  avr-objcopy -O ihex main.elf main.hex
 ```    
 **Makefile Datei (16.01.2018)**
 
 Unterhalb angeführt ist die oben beschriebene **Makefile** Datei.  
 Diese Datei haben wir für Übungszwecke in der Laboreinheit in zusammenarbeit mit Herrn Professor Steiner geschrieben.  
 
 
 Der letzte Schritt der Übung war, ein Blinklicht-Programm, mithilfe von *avrdude* 
 ```
  avrdude -c usbasp -p atmega328p -e -U flash:w:main.hex:i
 ```
 in unseren Microcontroller zuladen, um zu sehen ob auch alles funktioniert.  
 
 
```c
all: build

build: main.hex

cleanbuild: clean build


prog: main.hex
        avrdude -c usbasp -p atmega328p -e -U flash:w:main.hex:i
        touch prog

main.hex: main.elf


main.elf: util.o main.o
        avr-gcc -mmcu=atmega328p -o main.o util.o


main.o: main.c
        avr-gcc -mmcu=atmega328p -Os -c  main.c


util.o: util.c
        avr-gcc -mmcu=atmega328p -Os -c  util.c

clean: 
        -rm main.o
        -rm util.o
        -rm main
```

**main.c Datei (16.01.2018)**  

```
#define F_CPU 16000000L

#include <avr/io.h>
#include <util/delay.h>
#include  "util.h"

int main ()
{
        DDRB = (1<<PB5);
        while (1) 
        {
                toggleLED();
                _delay_ms(500);
        }
        return 0; 
}
```

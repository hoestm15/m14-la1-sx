
# *Protokoll:* Julian Ehmann  

## **6. Einheit: Temperaturmessung**  
 Name: Julian Ehmann  
 Klasse: 4AHME  
 Datum: 30.01.2018  
 Anwesend: Berger Emil, Böcksteiner Jakob, Ehmann Julian, Kobor Markus, Knappitsch Robert
 Abwesend: Bullner Jeremy, Enzi Gert
  
## Auftrag: Temperaturmessung
Mit einem Sureboard haben wir in der letzten Einheit eine Temperatursensor gebaut. Der Datenaustausch findet über Modbus (*Feldbus*) statt,welcher die Daten an einen Computer liefert, weclher die Daten auswertet. Eine bereits fertige JavaApplication soll die Daten visualisieren.


### Vorgehensweise
Zu beginn sollten wir vom Server die bereits fertig programmierte GUI herunterladen.  
Danach sollten wir eine Variable erstellen durch diese wir überprüfen können welcher Port geöffnez ist.
 
```java
private jssc.SerialPort serialPort;
```

### Konstruktor
```java
public SureModbusGui () 
{
    initComponents();
    setLocationRelativeTo(null);
    updateSwingControls();
    refrehPorts();
  }
```
Im oben gezeigten Konstruktor werden erstellte Methoden wie `refreshPorts();` und `updateSwingControls();` aufgerufen.

### showThrowable
```java
private void showThrowable (Throwable th) 
{
    th.printStackTrace(System.err);
    String msg = th.getMessage();
    if (msg == null || msg.isEmpty())
    {
      msg = th.getClass().getSimpleName();
    }
    JOptionPane.showMessageDialog(this,
                                  msg,
                                  "Fehler aufgetreten...",
                                  JOptionPane.ERROR_MESSAGE);
  }
```
Im falle eines Fehlers wird dieser über ein Pop-up-Fenster ausgegeben. Ebenso wird auch ``msg`` im Fenster ausgegeben. Sollte keine msg vorhanden sein wird der Klassenname in der der Fehler aufgetreten ist, ausgegeben.

### refreshPorts
```java
private void refrehPorts () 
{
    final String [] ports = jssc.SerialPortList.getPortNames();
    
    String preferedPort = null;  //Suchen nach USB
    for (String p : ports) 
    {
      if (p.contains("USB")) 
      {
        preferedPort = p;
        break;
      }
    }
    
    jcbSerialDevice.setModel(new DefaultComboBoxModel<String>(ports));  //Implementiert direkt ports
    
    if (preferedPort != null) 
    {
      jcbSerialDevice.setSelectedItem(preferedPort);  //Auswählen der gewünschten Schnittstelle
    }
    
    updateSwingControls();
    
  }
```
Hierbei wird ein String mit den Namen aller angezeigten Ports erstellt. Mit diesem Schleifendurchlauf gehen wir über den String und unterbrechen, sobald die Zeichenfolge "USB" gefunden wurden. Den Port "USB" setzen wir als *preferedPort*, damit wir diesen Port als Standard in der *Combobox* `jcbSerialDevice` setzen.

### connectPort
```java
private void connectPort(String port)
{
        serialPort = new jssc.SerialPort(port);
        try 
        {
            serialPort.openPort(); //Verbinden mit dem Port
        } catch (Throwable ex)
        {
            showThrowable(new Exception("Serielle Schnittstelle kann nicht geöffnet werden", ex));
            serialPort = null;
        } finally { //Egal, ob Fehler oder nicht
            updateSwingControls();
        }
    }
```
Im oben gezeigten Code-Auszug wird ein Port geöffnet. Das wird mit der Methode `.openPort();` durchgeführt. Sollte man mit seriellen Schnittstellen arbeiten, tretten JNI-Fehler anstatt `Exception` auf. Aus diesem Grund ist es verpflichtent bei catch mit der Methode `Throwable` alles zu fangen.


### disconnectPort
```java
private void disconnectPort() 
        {
        if (serialPort == null || !serialPort.isOpened()) 
        {
            showThrowable(new Exception("Interner Fehler!"));
            return;
        }

        try 
        {
            serialPort.closePort();
        } catch (Throwable th) 
        {
            showThrowable(new Exception("Serielle Schnittstelle kann nicht geschlossen werden"));
        } finally 
        {
            serialPort = null;
            updateSwingControls();
        }
    }
```
Die erste if-Verzweigung dient der Sicherhheit. Damit ist gemeint dass darauf geachtet wird, dass kein Port geschlossen werden kann wenn keiner geöffnet ist. Mit `.closePort();` wird der Port wieder geschlossen.

### updateSwingControls
```java
private void updateSwingControls() {
        jlaTemperatur.setText("--");
        jbutRefresh.setEnabled(true);
        jbutConnect.setEnabled(false);
        jbutDisconnect.setEnabled(false);
        jcbSerialDevice.setEnabled(false);
        jbutSingleMeasurement.setEnabled(false);
        jbutContinousMeasurement.setEnabled(false);
        jbutStopMeasurement.setEnabled(false);

        if (serialPort != null && serialPort.isOpened())
        {
            jbutRefresh.setEnabled(false);
            jbutDisconnect.setEnabled(true);
            jbutConnect.setEnabled(false);
            return;
        }

        if (jcbSerialDevice.getModel().getSize() > 0) 
        {
            jcbSerialDevice.setEnabled(true);
            jbutConnect.setEnabled(true);
        }
    }
```
* Sobald das Programm geöffnet wird *
* Wenn nichts verbunden ist, soll "--" angezeigt werden.
* Der Button "Aktualisieren" soll eingeblendet bleiben.
* Der Button "Verbinden" soll ausgeblendet werden.
* Der Button "Trennen" soll ausgeblendet werden.
* Die Combobox soll ausgeblendet werden.
* Der Button "Einzelmessung" soll ausgeblendet werden.
* Der Button "Laufend messen" soll ausgeblendet werden.
* Der Button "Stop" soll ausgeblendet werden.

**Wenn ein Port geöffnet wurde**
* Der Button "Aktualisieren" soll ausgeblendet werden.
* Der Button "Trennen" soll eingeblendet werden.
* Der Button "Verbinden" soll ausgeblendet werden.

**Wenn Ports gefunden wurden**
* Die Combobox soll eingeblendet werden
* Der Button "Verbinden" soll eingeblendet werden.

### ActionPerformed
```java
private void jbutConnectActionPerformed(java.awt.event.ActionEvent evt) 
  {                                                
      connectPort((String) jcbSerialDevice.getSelectedItem());  //Typecast, da Object nur Strings enthält
  }                                           

  private void jbutDisconnectActionPerformed(java.awt.event.ActionEvent evt) 
  {                                                   
      disconnectPort();
  }                                              

  private void jbutRefreshActionPerformed(java.awt.event.ActionEvent evt) 
  {                                                
      refrehPorts();
  }
```
`jcbSerialDevice.getSelectedItem()` gibt ein Objekt zurück, dass auf jeden Fall ein String sein muss. Daher müssen/können wir einen Typecast machen.

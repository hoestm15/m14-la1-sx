# 7.Protokoll  
  
  **Name**:  *Bernhard Reinbacher*  
  **Datum:** *15.05.2018*  
  **Uhrzeit:** *9:40-12:25*  
  **Gruppe:** *3*  
  
   
    
 **Abwesend:**   
 **Anwesend:** Bernhard Reinbacher,Ruffenacht Florian, Sackl Martin, Sackl Roland, Sammer Daniel, Schmuck Martin, Schuster Patrick  
 ***********************************************************************************************************************************  
 
# Wiederholung  
Zu beginn wurden die Funktionen der letzten Einheit nochmals besprochen. Weiters gab es eine Prüfung für jene, die in der letzten Einheit fehlten. Weitere Infos zur Java Applikation, dem Temperatursensor und den bereits geschriebenen Funktionen: [6.Protokoll](/reibem14/README_20_03_2018.md), [5.Protokoll](README_13_03_2018.md)  
***********************************************************************************************************************************  
## SingleMeasurementWorker  
Mithilfe eines eigenen Programmfadens(Thread), wird die Temperatur vom Sureoboard mittels Modbus übertragen. Zuerst wird vom PC eine Anfrage an das Sureboard(Slave) gesendet, diese beinhaltet 8 Bytes: 2 4 0 0x30 0 1 0x31 0xf6. Nach 100 ms Wartezeit, wird die Antwort des Sureboards ausgelesen und falls kein Fehler voliegt, befindet sich der Temperaturwert an Stelle 3 und 4. Wenn dies alles funktioniert hat, wird der Temperaturwert berechnet. Falls etwaige Fehler auftreten, wird eine Exception geworfen und der Fehler behandelt.  
  
  ```java  
    
package Workers;

import java.util.concurrent.TimeUnit;
import javax.swing.SwingWorker;
import jssc.SerialPort;



public class SingleMeasurementWorker extends SwingWorker<Double, String>
{
  
  private final SerialPort serialPort;


  public SingleMeasurementWorker (SerialPort serialPort)
  {
    this.serialPort = serialPort;
  }
  
  

  @Override
  protected Double doInBackground () throws Exception
  {
    publish("Sende Request an Modbus-Server");
    int [] request = {2, 4, 0, 0x30, 0, 1, 0x31, 0xf6};
    serialPort.writeIntArray(request);
    TimeUnit.MILLISECONDS.sleep(100);
    int [] response = serialPort.readIntArray();
    if(response == null || response.length == 0){
      throw new Modbusexception("keine Antwort erhalten", request);
    }
    
    publish("Modbus response mit  " + response.length + " Bytes eingetroffen");
    
    
    if(response.length <= 7){
      throw new Modbusexception("Zu kurze Antwort erhalten", request, response);
    }
    if(response[0] != 2){
      throw new Modbusexception("Antwort vom falschen Gerät erhalten", request, response);
    }
    
    if(response[1] != 4){
      throw new Modbusexception("Antwort mit falschem Function-Code", request, response);
    }
    
    if(response[2] != 2){
      throw new Modbusexception("Antwort mit falscher Anzahl an Bytes", request, response);
    }
    
    
    double temp = (response[3]*256.0 + response[4]) /256.0;
    
    return temp;
    
    
  }
  
}
  ```  
  ******************************************************************************************************************************  
  ## Fehlerbehandlung  
  Für unsere Temperaturmessung haben wir eine eigene Exception Klasse entworfen. Dafür wird das Antwortpaket auf bestimmte Merkmale überprüft und gegebenenfalls eine Exception geworfen.  
  
Programmcode | Beschreibung  
------------ | ------------    
if(response == null) | Überprüfung ob die Antwort leer ist.
if(response.length <= 7) | Überprüfung ob Antwort lang genug ist.  
if(response[0] != 2) | Überprüfung ob die Antwort vom richtigen Gerät kommt.  
if(response[1] != 4) | Überptüfung ob die Antwort den richtigen Funktionscode enthält.  
if(response[2] != 2) | Überprüfung ob die Antwort eine falsche Anzahl an Bytes bekommt.
    
  ```java  
    package Workers;



public class Modbusexception extends Exception
{
  private final int [] request;
  private final int [] response;  


  public Modbusexception (String message)
  {
    super(message);
    request = null;
    response = null;
  }
  
  public Modbusexception (String message, Throwable cause)
  {
    super(message, cause);
    request = null;
    response = null;
  }
  
  public Modbusexception (String message, int [] request)
  {
    super(message);
    this.request = request;
    response = null;
  }
  
  public Modbusexception (String message, int [] request, int [] response)
  {
    super(message);
    this.request = request;
    this.response = response;
  }


  public int[] getRequest ()
  {
    return request;
  }


  public int[] getResponse ()
  {
    return response;
  }
 }
 ```  
 

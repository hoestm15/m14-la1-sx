# Protokoll
  Berger Emil  
  4AHME, Gruppe 1  
  30.01.18  
  Anwesend: Berger, Böcksteiner, Ehmann, Kobor, Knappitsch  
  Abwesend: Bullner, Enzi
  
## Projekt: Temperaturmessung
In der letzten Einheit erlernten wir die Grundlagen über Modbus und JNI (bzw. jssc.jar) [Protokoll, 5. Einheit](https://github.com/HTLMechatronics/m14-la1-sx/blob/Beremm14/beremm14/README_2018-1-23.md). Mit Hilfe eines Sureboards wird nun ein Temperatursensor gebaut. Die Daten sind mittels eines Feldbus' (in unserem Fall Modbus) an einen Computer zu übertragen, der die Daten auswertet. Eine Java-Swing-Application soll die erhaltenen Daten visualisieren.

### Vorlage
Wir luden vom Arnfels-Server folgende GUI-Vorlage herunter:
![Angabe](https://github.com/beremm14/Temperaturmessung_sure/blob/master/Screenshots/Angabe.png)

### Erstellter Quellcode
Das gesamte Projekt ist abrufbar auf meinem [Repository](https://github.com/beremm14/Temperaturmessung_sure)

#### Klassenvariablen
Zuerst wurde ein Variable erstellt, mit der abgefrag werden kann, ob ein Port geöffnet ist. 
```java
private jssc.SerialPort serialPort;
```

#### Konstruktor
```java
public SureModbusGui () {
    initComponents();
    setLocationRelativeTo(null);
    updateSwingControls();
    refrehPorts();
  }
```
Im Konstruktor werden die beiden erstellten Methoden `updateSwingControls();` und `refreshPorts();` aufgerufen, damit sie beim Programmstart ausgeführt werden.

#### showThrowable
```java
private void showThrowable (Throwable th) {
    th.printStackTrace(System.err);
    String msg = th.getMessage();
    if (msg == null || msg.isEmpty()) {
      msg = th.getClass().getSimpleName();
    }
    JOptionPane.showMessageDialog(this,
                                  msg,
                                  "Fehler aufgetreten...",
                                  JOptionPane.ERROR_MESSAGE);
  }
```
Sollte ein Fehler auftreten wird er über ein Pop-up-Fenster ausgegeben. Die Fehlernachricht `msg` wird auch im Fenster ausgegeben. Sollte keine [msg] exisitieren, wird der Klassenname, wo der Fehler aufgetreten ist, ausgegeben.

#### refreshPorts
```java
private void refrehPorts () {
    final String [] ports = jssc.SerialPortList.getPortNames();
    
    String preferedPort = null;  //Suchen nach USB
    for (String p : ports) {
      if (p.contains("USB")) {
        preferedPort = p;
        break;
      }
    }
    
    jcbSerialDevice.setModel(new DefaultComboBoxModel<String>(ports));  //Implementiert direkt ports
    
    if (preferedPort != null) {
      jcbSerialDevice.setSelectedItem(preferedPort);  //Auswählen der gewünschten Schnittstelle
    }
    
    updateSwingControls();
    
  }
```
Es wird ein String mit den Namen aller gefundenen Ports erstellt. Mit der [for-each-Schleife](https://de.wikipedia.org/wiki/For-Schleife#Die_Foreach-Schleife) iterieren wir über den String und unterbrechen, wenn die Zeichen "USB" gefunden wurden. Den Port, der "USB" enthält, setzen wir als unseren *preferedPort*, um diesen Port als Standard in der *Combobox* `jcbSerialDevice` zu setzen.

#### connectPort
```java
private void connectPort(String port) {
        serialPort = new jssc.SerialPort(port);
        try {
            serialPort.openPort(); //Verbinden mit dem Port
        } catch (Throwable ex)
        {
            showThrowable(new Exception("Serielle Schnittstelle kann nicht geöffnet werden", ex));
            serialPort = null;
        } finally { //Egal, ob Fehler oder nicht
            updateSwingControls();
        }
    }
```
Mit dieser Methode wird ein Port geöffnet. Dies wird mit der Methode `.openPort();` realisiert. Wenn man mit seriellen Schnittstellen arbeitet, werden JNI-Fehler statt als `Exception` als `Error` ausgegeben. Daher muss man bei catch mittels `Throwable` alles fangen. (Throwable = parent von Error und Exception, siehe Bild unten.) Das Selbe gilt für die Methode `disconnectPort();`

![Throwable](https://qph.ec.quoracdn.net/main-qimg-5ecddcf1e67627ec3730de4020041c22-c)

#### disconnectPort
```java
private void disconnectPort() {
        if (serialPort == null || !serialPort.isOpened()) {
            showThrowable(new Exception("Interner Fehler!"));
            return;
        }

        try {
            serialPort.closePort();
        } catch (Throwable th) {
            showThrowable(new Exception("Serielle Schnittstelle kann nicht geschlossen werden"));
        } finally {
            serialPort = null;
            updateSwingControls();
        }
    }
```
Die erste if-Verzweigung dient nur zur Sicherhheit, dass kein Port geschlossen werden kann, wenn nicht einmal einer geöffnet ist. (Normalerweise sollte dies aber kein Problem darstellen, da der Button *Trennen* sowieso ausgeblendet ist, wenn kein Port verbunden ist). Mit `.closePort();` wird der Port wieder geschlossen.

#### updateSwingControls
```java
private void updateSwingControls() {
        jlaTemperatur.setText("--");
        jbutRefresh.setEnabled(true);
        jbutConnect.setEnabled(false);
        jbutDisconnect.setEnabled(false);
        jcbSerialDevice.setEnabled(false);
        jbutSingleMeasurement.setEnabled(false);
        jbutContinousMeasurement.setEnabled(false);
        jbutStopMeasurement.setEnabled(false);

        if (serialPort != null && serialPort.isOpened()) {
            jbutRefresh.setEnabled(false);
            jbutDisconnect.setEnabled(true);
            jbutConnect.setEnabled(false);
            return;
        }

        if (jcbSerialDevice.getModel().getSize() > 0) {
            jcbSerialDevice.setEnabled(true);
            jbutConnect.setEnabled(true);
        }
    }
```
**Wenn das Programm geöffnet wird**
* Wenn nichts verbunden ist, soll "--" angezeigt werden.
* Der Button "Aktualisieren" soll eingeblendet bleiben.
* Der Button "Verbinden" soll ausgeblendet werden.
* Der Button "Trennen" soll ausgeblendet werden.
* Die Combobox soll ausgeblendet werden.
* Der Button "Einzelmessung" soll ausgeblendet werden.
* Der Button "Laufend messen" soll ausgeblendet werden.
* Der Button "Stop" soll ausgeblendet werden.

**Wenn ein Port geöffnet wurde**
* Der Button "Aktualisieren" soll ausgeblendet werden.
* Der Button "Trennen" soll eingeblendet werden.
* Der Button "Verbinden" soll ausgeblendet werden.

**Wenn Ports gefunden wurden**
* Die Combobox soll eingeblendet werden
* Der Button "Verbinden" soll eingeblendet werden.

#### ActionPerformed
```java
private void jbutConnectActionPerformed(java.awt.event.ActionEvent evt) {                                                
      connectPort((String) jcbSerialDevice.getSelectedItem());  //Typecast, da Object nur Strings enthält
  }                                           

  private void jbutDisconnectActionPerformed(java.awt.event.ActionEvent evt) {                                                   
      disconnectPort();
  }                                              

  private void jbutRefreshActionPerformed(java.awt.event.ActionEvent evt) {                                                
      refrehPorts();
  }
```
Von `jcbSerialDevice.getSelectedItem()` bekommen wir ein Objekt zurück, wissen aber, dass es sich auf jeden Fall um einen String handeln muss. Daher können wir den Typecast `(String)` machen.

### Endergebnis nach der Einheit
[Repository des Projekts](https://github.com/beremm14/Temperaturmessung_sure)

#### Keine Ports gefunden ([macOS High Sierra](https://de.wikipedia.org/wiki/MacOS))
![Keine Ports gefunden](https://github.com/beremm14/Temperaturmessung_sure/blob/master/Screenshots/2018-01-30/Keine%20Ports%20gefunden.png)
macOS zeigt keine Ports an, wenn kein Endgerät angeschlossen ist.

#### Ports gefunden ([Ubuntu 16.04 LTS](https://de.wikipedia.org/wiki/Ubuntu))
![Ports gefunden](https://github.com/beremm14/Temperaturmessung_sure/blob/master/Screenshots/2018-01-30/Ports%20gefunden.png)
Zum Testen wurde ein Arduino angeschlossen.

#### Port verbunden ([Ubuntu 16.04 LTS](https://de.wikipedia.org/wiki/Ubuntu))
![Port verbunden](https://github.com/beremm14/Temperaturmessung_sure/blob/master/Screenshots/2018-01-30/Port%20verbunden.png)
Der Port des Arduinos wurde geöffnet.

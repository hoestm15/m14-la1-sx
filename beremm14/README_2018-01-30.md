# Protokoll
  Berger Emil  
  4AHME, Gruppe 1  
  30.01.18  
  Anwesend: Berger, Böcksteiner, Ehmann, Kobor, Knappitsch  
  Abwesend: Bullner, Enzi
  
## Projekt: Temperaturmessung
In der letzten Einheit erlernten wir die Grundlagen über Modbus und JNI (bzw. jssc.jar) [Protokoll, 5. Einheit](https://github.com/HTLMechatronics/m14-la1-sx/blob/Beremm14/beremm14/README_2018-1-23.md). Mit Hilfe eines Sureboards wird nun ein Temperatursensor gebaut. Die Daten sind mittels eines Feldbus' (in unserem Fall Modbus) an einen Computer zu übertragen, der die Daten auswertet. Eine Java-Swing-Application soll die erhaltenen Daten visualisieren.

### Vorlage
Wir luden vom Arnfels-Server folgende GUI-Vorlage herunter:
![Anfang](https://github.com/beremm14/Temperaturmessung_sure/blob/master/Screenshots/Anfang_2018-01-30.png)

### Erstellter Quellcode
Das gesamte Projekt ist abrufbar auf meinem [Repository](https://github.com/beremm14/Temperaturmessung_sure)

#### Klassenvariablen
Zuerst wurde ein Variable erstellt, mit der abgefrag werden kann, ob ein Port geöffnet ist.
```java
private jssc.SerialPort serialPort;
```

#### Konstruktor
```java
public SureModbusGui () {
    initComponents();
    setLocationRelativeTo(null);
    updateSwingControls();
    refrehPorts();
  }
```
Im Konstruktor werden die beiden erstellten Methoden `updateSwingControls();` und `refreshPorts();` aufgerufen.

#### showThrowable
```java
private void showThrowable (Throwable th) {
    th.printStackTrace(System.err);
    String msg = th.getMessage();
    if (msg == null || msg.isEmpty()) {
      msg = th.getClass().getSimpleName();
    }
    JOptionPane.showMessageDialog(this,
                                  msg,
                                  "Fehler aufgetreten...",
                                  JOptionPane.ERROR_MESSAGE);
  }
```
Sollte ein Fehler auftreten wird er über ein Pop-up-Fenster ausgegeben. Die Fehlernachricht `msg` wird auch im Fenster ausgegeben. Sollte keine exisitieren, wird der Klassenname, wo der Fehler aufgetreten ist, ausgegeben.

#### refreshPorts
```java
private void refrehPorts () {
    final String [] ports = jssc.SerialPortList.getPortNames();
    
    String preferedPort = null;  //Suchen nach USB
    for (String p : ports) {
      if (p.contains("USB")) {
        preferedPort = p;
        break;
      }
    }
    
    jcbSerialDevice.setModel(new DefaultComboBoxModel<String>(ports));  //Implementiert direkt ports
    
    if (preferedPort != null) {
      jcbSerialDevice.setSelectedItem(preferedPort);  //Auswählen der gewünschten Schnittstelle
    }
    
    updateSwingControls();
    
  }
```
Es wird ein String mit den Namen aller gefundenen Ports erstellt. Mit der [for-each-Schleife](https://de.wikipedia.org/wiki/For-Schleife#Die_Foreach-Schleife) iterieren wir über den String und unterbrechen, wenn die Zeichen "USB" gefunden wurden. Den Port, der "USB" enthält, setzen wir als unseren *preferedPort*, um diesen Port als Standard in der *Combobox* zu setzen.

#### connectPort
```java
private void connectPort(String port) {
        serialPort = new jssc.SerialPort(port);
        try {
            serialPort.openPort(); //Verbinden mit dem Port
        } catch (Throwable ex)
        {
            showThrowable(new Exception("Serielle Schnittstelle kann nicht geöffnet werden", ex));
            serialPort = null;
        } finally { //Egal, ob Fehler oder nicht
            updateSwingControls();
        }
    }
```
Mit dieser Methode wird ein Port geöffnet. Dies wird mit der Methode `.openPort();` realisiert. Wenn man mit seriellen Schnittstellen arbeitet, werden JNI-Fehler statt als `Exception` als `Error` ausgegeben. Daher muss man bei catch mittels `Throwable` alles fangen. (Throwable = parent von Error und Exception, siehe Bild unten.) Das Selbe gilt für die Methode `disconnectPort();`
![Throwable](https://www.google.at/url?sa=i&rct=j&q=&esrc=s&source=images&cd=&ved=&url=https%3A%2F%2Fqph.ec.quoracdn.net%2Fmain-qimg-5ecddcf1e67627ec3730de4020041c22-c&psig=AOvVaw3vV9zmGqFNguk-1_Q3NJmK&ust=1517845257157352)

#### disconnectPort
```java
private void disconnectPort() {
        if (serialPort == null || !serialPort.isOpened()) {
            showThrowable(new Exception("Interner Fehler!"));
            return;
        }

        try {
            serialPort.closePort();
        } catch (Throwable th) {
            showThrowable(new Exception("Serielle Schnittstelle kann nicht geschlossen werden"));
        } finally {
            serialPort = null;
            updateSwingControls();
        }
    }
```
